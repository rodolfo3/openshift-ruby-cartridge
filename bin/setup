#!/bin/bash -eu

source $OPENSHIFT_CARTRIDGE_SDK_BASH

cd $OPENSHIFT_TMP_DIR
wget http://cache.ruby-lang.org/pub/ruby/2.1/ruby-2.1.2.tar.gz
tar zxvf ruby-2.1.2.tar.gz

cd ruby*
./configure --enable-shared --disable-install-doc --prefix=$OPENSHIFT_RUBY_DIR
make
make install

cd $OPENSHIFT_RUBY_DIR
cp ruby/lib/ruby/2.1.0/resolv.rb ruby/lib/ruby/2.1.0/resolv.rb.erb
sed -i 's/0.0.0.0/<%= ENV["OPENSHIFT_NGINX_IP"] %>/g' ruby/lib/ruby/2.1.0/resolv.rb.erb
erb ruby/lib/ruby/2.1.0/resolv.rb.erb > ruby/lib/ruby/2.1.0/resolv.rb
